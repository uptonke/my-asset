<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡ç”¢ç®¡ç†å¤§å¸« v8.0 | å°å¹£/ç¾é‡‘é›™è»Œåˆ¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Microsoft JhengHei', 'Segoe UI', Roboto, sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .input-dark { background: #1e293b; border: 1px solid #475569; color: white; transition: all 0.2s; }
        .input-dark:focus { border-color: #3b82f6; ring: 2px; outline: none; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: bold; }
        .tab-inactive { color: #94a3b8; }
        .tab-inactive:hover { color: #cbd5e1; }
        .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .card-header { border-left: 4px solid #3b82f6; padding-left: 1rem; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm">

<div id="app" class="h-full flex flex-col">
    
    <header class="glass z-50 flex-none h-16 px-6 flex items-center justify-between shadow-lg">
        <div class="flex items-center gap-6">
            <h1 class="font-bold text-xl tracking-wide flex items-center gap-2 text-white">
                <i class="fas fa-chart-pie text-blue-500"></i> è³‡ç”¢ç®¡ç†å¤§å¸« <span class="text-xs bg-blue-600 px-2 py-0.5 rounded text-white">v8.0 ä¸­æ–‡ç‰ˆ</span>
            </h1>
            
            <div class="hidden md:flex items-center gap-3 bg-slate-800 py-1 px-3 rounded-lg border border-slate-700">
                <span class="text-gray-400 text-xs">ç¾é‡‘åŒ¯ç‡ (USD/TWD):</span>
                <input v-model.number="exchangeRate" type="number" step="0.01" class="w-16 bg-transparent text-center font-mono font-bold text-green-400 focus:outline-none border-b border-gray-600">
            </div>

            <nav class="flex gap-6 font-medium ml-4 hidden md:flex">
                <button @click="currentTab='summary'" :class="currentTab==='summary'?'tab-active':'tab-inactive'" class="py-4 px-2 transition"><i class="fas fa-home mr-1"></i> ç¸½è¦½</button>
                <button @click="currentTab='holdings'" :class="currentTab==='holdings'?'tab-active':'tab-inactive'" class="py-4 px-2 transition"><i class="fas fa-wallet mr-1"></i> åº«å­˜æ˜ç´°</button>
                <button @click="currentTab='analytics'" :class="currentTab==='analytics'?'tab-active':'tab-inactive'" class="py-4 px-2 transition"><i class="fas fa-chart-line mr-1"></i> é‡åŒ–åˆ†æ</button>
                <button @click="currentTab='ledger'" :class="currentTab==='ledger'?'tab-active':'tab-inactive'" class="py-4 px-2 transition"><i class="fas fa-list mr-1"></i> äº¤æ˜“ç´€éŒ„</button>
            </nav>
        </div>
        <div class="flex gap-3">
             <button @click="generateMockData" class="p-2 text-purple-400 hover:text-white transition" title="ç”¢ç”Ÿæ¸¬è©¦æ•¸æ“š (è®“åœ–è¡¨å‹•èµ·ä¾†)"><i class="fas fa-flask"></i></button>
             <button @click="fetchPrices" class="p-2 text-blue-400 hover:text-white transition" title="æ›´æ–°å ±åƒ¹"><i class="fas fa-sync-alt" :class="{'fa-spin': isUpdating}"></i></button>
             <button @click="exportAll" class="p-2 text-green-400 hover:text-white transition" title="å‚™ä»½è³‡æ–™"><i class="fas fa-download"></i></button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 md:p-6 bg-[#0f172a]">
        <div class="max-w-7xl mx-auto h-full space-y-6">

            <div v-if="currentTab === 'summary'" class="animate-fade-in space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="glass p-6 rounded-2xl border-t-4 border-blue-500">
                        <div class="text-xs text-gray-400 font-bold uppercase">ç¸½è³‡ç”¢ (Total Assets)</div>
                        <div class="text-3xl font-bold text-white mt-2 font-mono">NT$ {{ formatNumber(totalAssetsTwd) }}</div>
                        <div class="text-xs text-gray-500 mt-2">ä»¥å°å¹£è¨ˆåƒ¹</div>
                    </div>
                    <div class="glass p-6 rounded-2xl border-t-4 border-emerald-500">
                        <div class="text-xs text-gray-400 font-bold uppercase">ç¸½æŠ•å…¥æˆæœ¬ (Cost)</div>
                        <div class="text-3xl font-bold text-white mt-2 font-mono">NT$ {{ formatNumber(totalPrincipalTwd) }}</div>
                    </div>
                    <div class="glass p-6 rounded-2xl border-t-4" :class="totalUnrealizedPL >= 0 ? 'border-red-500' : 'border-green-500'">
                        <div class="text-xs text-gray-400 font-bold uppercase">æœªå¯¦ç¾æç›Š (P/L)</div>
                        <div class="text-3xl font-bold mt-2 font-mono" :class="totalUnrealizedPL >= 0 ? 'text-red-400' : 'text-green-400'">
                            {{ totalUnrealizedPL >= 0 ? '+' : '' }}{{ formatNumber(totalUnrealizedPL) }}
                        </div>
                        <div class="text-sm font-bold mt-1" :class="totalUnrealizedPL >= 0 ? 'text-red-400' : 'text-green-400'">
                            å ±é…¬ç‡: {{ totalReturnRate }}%
                        </div>
                    </div>
                    <div class="glass p-6 rounded-2xl border-t-4 border-purple-500">
                         <div class="text-xs text-gray-400 font-bold uppercase">è³‡ç”¢åˆ†ä½ˆ</div>
                         <div class="mt-3 space-y-2">
                             <div class="flex justify-between text-xs" v-for="(val, cat) in categoryTotals" :key="cat">
                                 <span class="text-gray-300">{{ cat }}</span>
                                 <span class="font-mono text-white">{{ formatPercent(val / totalAssetsTwd) }}</span>
                             </div>
                         </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-96">
                    <div class="glass p-5 rounded-2xl col-span-1 flex flex-col">
                        <h4 class="text-white font-bold mb-4 card-header">è³‡ç”¢é…ç½®åœ“é¤…åœ–</h4>
                        <div class="flex-1 relative"><canvas id="allocationChart"></canvas></div>
                    </div>
                    <div class="glass p-5 rounded-2xl col-span-2 flex flex-col">
                        <h4 class="text-white font-bold mb-4 card-header">è³‡ç”¢æˆé•·è¶¨å‹¢åœ– (å°å¹£è¨ˆåƒ¹)</h4>
                        <div class="flex-1 relative"><canvas id="historyChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'holdings'" class="flex flex-col h-full max-h-[85vh] space-y-4 animate-fade-in">
                
                <div class="glass rounded-xl overflow-hidden flex flex-col flex-1">
                    <div class="p-4 bg-gray-800/50 border-b border-gray-700 flex justify-between items-center">
                        <h3 class="font-bold text-white"><i class="fas fa-layer-group text-blue-500 mr-2"></i>åˆ†é¡åº«å­˜å ±è¡¨</h3>
                        <div class="text-xs text-gray-400">
                            å ±åƒ¹ä¾†æº: <span :class="sheetUrl ? 'text-green-400' : 'text-yellow-400'">{{ sheetUrl ? 'Google Finance é€£ç·šä¸­' : 'æ‰‹å‹•è¼¸å…¥æ¨¡å¼' }}</span>
                        </div>
                    </div>
                    
                    <div class="overflow-auto flex-1 p-4 space-y-6">
                        
                        <div v-for="cat in ['å°è‚¡', 'ç¾è‚¡', 'åŸºé‡‘', 'åŠ å¯†è²¨å¹£']" :key="cat" v-if="holdings.some(h => h.category === cat)" class="border border-gray-700 rounded-lg overflow-hidden">
                            <div class="bg-gray-800 p-3 flex justify-between items-center border-b border-gray-700">
                                <span class="font-bold text-white text-sm border-l-4 pl-2" :class="getCategoryColor(cat)">{{ cat }}</span>
                                <span class="text-xs text-gray-400">
                                    å°è¨ˆ: <span class="text-white font-bold font-mono">NT$ {{ formatNumber(holdings.filter(h=>h.category===cat).reduce((a,b)=>a+b.marketValueTwd,0)) }}</span>
                                </span>
                            </div>
                            <table class="w-full text-left whitespace-nowrap bg-gray-900/30">
                                <thead class="text-xs text-gray-500 uppercase">
                                    <tr>
                                        <th class="p-3 pl-4">ä»£è™Ÿ/åç¨±</th>
                                        <th class="p-3 text-right">æ•¸é‡</th>
                                        <th class="p-3 text-right">å‡åƒ¹ (åŸå¹£)</th>
                                        <th class="p-3 text-right">ç¾åƒ¹ (åŸå¹£)</th>
                                        <th class="p-3 text-right">å¸‚å€¼ (å°å¹£)</th>
                                        <th class="p-3 text-right">æç›Š (å°å¹£)</th>
                                        <th class="p-3 text-right">å ±é…¬ç‡</th>
                                    </tr>
                                </thead>
                                <tbody class="text-sm divide-y divide-gray-800">
                                    <tr v-for="stock in holdings.filter(h => h.category === cat)" :key="stock.ticker" class="hover:bg-white/5 transition">
                                        <td class="p-3 pl-4 font-bold text-white">{{ stock.ticker }}</td>
                                        <td class="p-3 text-right font-mono text-gray-400">{{ formatNumber(stock.shares) }}</td>
                                        <td class="p-3 text-right font-mono text-gray-500">{{ formatNumber(stock.avgCost) }}</td>
                                        <td class="p-3 text-right font-mono font-bold">
                                            <input v-model.number="stock.manualPrice" @change="manualUpdate(stock)" class="w-24 bg-transparent text-right outline-none border-b border-gray-700 focus:border-blue-500 text-yellow-400 placeholder-gray-600" placeholder="è¼¸å…¥ç¾åƒ¹">
                                        </td>
                                        <td class="p-3 text-right font-mono text-white font-bold">{{ formatNumber(stock.marketValueTwd) }}</td>
                                        <td class="p-3 text-right font-bold" :class="stock.unrealizedPLTwd >= 0 ? 'text-red-400' : 'text-green-400'">
                                            {{ formatNumber(stock.unrealizedPLTwd) }}
                                        </td>
                                        <td class="p-3 text-right font-bold text-xs" :class="stock.returnRate >= 0 ? 'text-red-400' : 'text-green-400'">
                                            {{ stock.returnRate }}%
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                         <div class="bg-gray-800 p-4 rounded-lg flex justify-between border-l-4 border-gray-500">
                             <span class="font-bold text-gray-300">ç¾é‡‘é¤˜é¡ (Cash)</span>
                             <span class="font-mono text-white font-bold">NT$ {{ formatNumber(cashBalanceTwd) }}</span>
                         </div>

                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'analytics'" class="flex flex-col h-full space-y-4 animate-fade-in">
                
                <div class="glass p-5 rounded-xl flex flex-wrap items-center justify-between gap-4">
                    <div>
                        <h3 class="font-bold text-white text-lg">é‡åŒ–é¢¨éšªæŒ‡æ¨™ (Quantitative Metrics)</h3>
                        <p class="text-xs text-gray-400 mt-1" v-if="historyData.length < 3">âš ï¸ æ•¸æ“šä¸è¶³ï¼šè«‹æŒ‰å³ä¸Šè§’ã€Œç”¢ç”Ÿæ¸¬è©¦æ•¸æ“šã€æˆ–ç´¯ç©è‡³å°‘ 3 å¤©çš„å¿«ç…§ã€‚</p>
                        <p class="text-xs text-gray-400 mt-1" v-else>åŸºæ–¼éå» {{ historyData.length }} ç­†æ­·å²ç´€éŒ„è¨ˆç®—</p>
                    </div>
                    <div class="flex gap-4 items-center">
                        <div class="flex items-center gap-2 text-xs">
                             <label class="text-gray-400">ç„¡é¢¨éšªåˆ©ç‡(%):</label>
                             <input v-model.number="riskParams.rf" type="number" step="0.1" class="w-16 input-dark p-1 rounded text-center">
                        </div>
                        <button @click="takeSnapshot" class="btn-primary text-white px-6 py-2 rounded-lg font-bold shadow-lg flex items-center gap-2">
                            <i class="fas fa-camera"></i> ç´€éŒ„ä»Šæ—¥ç‹€æ…‹
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="glass p-4 rounded-xl text-center"><div class="text-xs text-blue-400 uppercase tracking-wider">å¤æ™®æ¯”ç‡ (Sharpe)</div><div class="text-xl font-mono text-white font-bold mt-1">{{ stats.sharpe }}</div></div>
                    <div class="glass p-4 rounded-xl text-center"><div class="text-xs text-blue-400 uppercase tracking-wider">ç´¢æè«¾ (Sortino)</div><div class="text-xl font-mono text-white font-bold mt-1">{{ stats.sortino }}</div></div>
                    <div class="glass p-4 rounded-xl text-center"><div class="text-xs text-red-400 uppercase tracking-wider">é¢¨éšªå€¼ (VaR 95%)</div><div class="text-xl font-mono text-white font-bold mt-1">{{ stats.var95 }}%</div></div>
                    <div class="glass p-4 rounded-xl text-center"><div class="text-xs text-gray-400 uppercase tracking-wider">æ¨™æº–å·® (æ³¢å‹•ç‡)</div><div class="text-xl font-mono text-white font-bold mt-1">{{ stats.stdDev }}%</div></div>
                    <div class="glass p-4 rounded-xl text-center"><div class="text-xs text-yellow-400 uppercase tracking-wider">æœ€å¤§å›æ’¤ (MDD)</div><div class="text-xl font-mono text-white font-bold mt-1">{{ stats.mdd }}%</div></div>
                 </div>

                 <div class="flex-1 glass rounded-xl overflow-hidden flex flex-col">
                    <div class="overflow-auto flex-1">
                        <table class="w-full text-left whitespace-nowrap">
                            <thead class="sticky top-0 bg-[#0f172a] text-xs text-gray-400 uppercase font-semibold">
                                <tr>
                                    <th class="p-3 pl-6">æ—¥æœŸ</th>
                                    <th class="p-3 text-right">ç¸½è³‡ç”¢ (å°å¹£)</th>
                                    <th class="p-3 text-right">ç¸½æˆæœ¬ (å°å¹£)</th>
                                    <th class="p-3 text-right">å–®æ—¥å ±é…¬</th>
                                    <th class="p-3 text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm divide-y divide-white/5">
                                <tr v-for="(h, idx) in historyData.slice().reverse()" :key="idx" class="hover:bg-white/5">
                                    <td class="p-3 pl-6 font-mono text-blue-300">{{ h.date }}</td>
                                    <td class="p-3 text-right font-mono text-white font-bold">{{ formatNumber(h.assets) }}</td>
                                    <td class="p-3 text-right font-mono text-gray-500">{{ formatNumber(h.cost) }}</td>
                                    <td class="p-3 text-right font-mono" :class="h.dailyReturn >= 0 ? 'text-red-400' : 'text-green-400'">
                                        {{ h.dailyReturn ? (h.dailyReturn * 100).toFixed(2) + '%' : '-' }}
                                    </td>
                                    <td class="p-3 text-center">
                                        <button @click="removeHistory(historyData.length - 1 - idx)" class="text-gray-600 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                 </div>
            </div>

            <div v-if="currentTab === 'ledger'" class="flex flex-col md:flex-row gap-6 h-full max-h-[85vh]">
                 
                 <div class="w-full md:w-80 glass p-5 rounded-xl h-fit space-y-4">
                    <h3 class="font-bold text-white text-lg border-b border-gray-700 pb-2">æ–°å¢äº¤æ˜“ / è³‡ç”¢</h3>
                    
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">1. é¸æ“‡è³‡ç”¢é¡åˆ¥ (Category)</label>
                        <div class="grid grid-cols-2 gap-2">
                             <button @click="txForm.category='å°è‚¡'" :class="txForm.category==='å°è‚¡'?'bg-blue-600 text-white':'bg-gray-700 text-gray-400'" class="p-2 rounded text-xs transition">å°è‚¡</button>
                             <button @click="txForm.category='ç¾è‚¡'" :class="txForm.category==='ç¾è‚¡'?'bg-indigo-600 text-white':'bg-gray-700 text-gray-400'" class="p-2 rounded text-xs transition">ç¾è‚¡</button>
                             <button @click="txForm.category='åŸºé‡‘'" :class="txForm.category==='åŸºé‡‘'?'bg-green-600 text-white':'bg-gray-700 text-gray-400'" class="p-2 rounded text-xs transition">åŸºé‡‘</button>
                             <button @click="txForm.category='åŠ å¯†è²¨å¹£'" :class="txForm.category==='åŠ å¯†è²¨å¹£'?'bg-purple-600 text-white':'bg-gray-700 text-gray-400'" class="p-2 rounded text-xs transition">åŠ å¯†è²¨å¹£</button>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">2. äº¤æ˜“è³‡è¨Š</label>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <input v-model="txForm.date" type="date" class="input-dark p-2 rounded text-xs col-span-2">
                            <select v-model="txForm.type" class="input-dark p-2 rounded text-xs col-span-2">
                                <option value="Buy">Buy (è²·å…¥/å…¥é‡‘)</option>
                                <option value="Sell">Sell (è³£å‡º)</option>
                                <option value="Deposit">Deposit (ç´”å…¥é‡‘-ç¾é‡‘)</option>
                                <option value="Dividend">Dividend (è‚¡æ¯)</option>
                            </select>
                        </div>
                        <input v-model="txForm.ticker" placeholder="ä»£è™Ÿ / åç¨± (å¦‚ BTC, 0050)" class="w-full input-dark p-2 rounded text-xs uppercase mb-2">
                        
                        <div v-if="['Buy','Sell'].includes(txForm.type)" class="grid grid-cols-2 gap-2 mb-2">
                            <input v-model.number="txForm.price" type="number" placeholder="å–®åƒ¹" class="input-dark p-2 rounded text-xs">
                            <input v-model.number="txForm.shares" type="number" placeholder="æ•¸é‡" class="input-dark p-2 rounded text-xs">
                        </div>
                        
                        <input v-model.number="txForm.amount" type="number" :placeholder="txForm.type==='Buy'?'æ‰‹çºŒè²»':'ç¸½é‡‘é¡'" class="w-full input-dark p-2 rounded text-xs">
                    </div>
                    
                    <div class="p-3 bg-blue-900/20 rounded text-xs text-blue-300 border border-blue-900/50">
                        <i class="fas fa-info-circle mr-1"></i> 
                        <span v-if="txForm.category==='ç¾è‚¡' || txForm.category==='åŠ å¯†è²¨å¹£'">é‡‘é¡è«‹è¼¸å…¥ <strong>ç¾é‡‘</strong></span>
                        <span v-else>é‡‘é¡è«‹è¼¸å…¥ <strong>å°å¹£</strong></span>
                    </div>

                    <button @click="addTransaction" class="w-full btn-primary text-white rounded-lg font-bold text-sm py-3 shadow-lg">ç¢ºèªé€å‡º</button>
                 </div>

                 <div class="flex-1 glass rounded-xl overflow-hidden flex flex-col">
                    <div class="p-4 bg-gray-800/50 border-b border-gray-700">
                        <h3 class="font-bold text-white">äº¤æ˜“æµæ°´å¸³</h3>
                    </div>
                    <div class="overflow-auto flex-1">
                        <table class="w-full text-left">
                            <thead class="sticky top-0 bg-[#0f172a] text-xs text-gray-400 uppercase font-semibold">
                                <tr><th class="p-3">æ—¥æœŸ</th><th class="p-3">é¡åˆ¥</th><th class="p-3">è³‡ç”¢</th><th class="p-3">åç¨±</th><th class="p-3 text-right">ç¾é‡‘æµ</th><th class="p-3"></th></tr>
                            </thead>
                            <tbody class="text-sm divide-y divide-white/5">
                                <tr v-for="(tx, idx) in reversedTransactions" :key="idx" class="hover:bg-white/5">
                                    <td class="p-3 text-gray-400">{{ tx.date }}</td>
                                    <td class="p-3 font-bold" :class="getTypeColor(tx.type)">{{ tx.type }}</td>
                                    <td class="p-3 text-xs text-gray-500">{{ tx.category }}</td>
                                    <td class="p-3 text-white">{{ tx.ticker || '-' }}</td>
                                    <td class="p-3 text-right font-mono text-white">{{ formatNumber(tx.totalCashFlow) }}</td>
                                    <td class="p-3 text-center"><button @click="removeTransaction(transactions.length - 1 - idx)" class="text-gray-600 hover:text-red-500"><i class="fas fa-times"></i></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                 </div>
            </div>

            <div v-if="!sheetUrl && showSetup" class="fixed inset-0 bg-black/90 flex items-center justify-center z-[100]">
                <div class="glass p-8 rounded-xl w-96 text-center border border-blue-500/30">
                    <h2 class="text-xl font-bold mb-4 text-white">åˆå§‹åŒ–æ‚¨çš„è³‡ç”¢åº«</h2>
                    <input v-model="tempUrl" placeholder="è²¼ä¸Š Google Sheet CSV é€£çµ (é¸å¡«)" class="w-full input-dark p-3 rounded mb-4 text-xs">
                    <button @click="saveUrl" class="w-full btn-primary py-2 rounded text-white font-bold mb-3">é€£çµè³‡æ–™åº«</button>
                    <button @click="showSetup=false" class="text-xs text-gray-500 hover:text-white">è·³é (ä½¿ç”¨æ‰‹å‹•æ¨¡å¼)</button>
                </div>
            </div>

        </div>
    </main>
</div>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue;

createApp({
    setup() {
        const currentTab = ref('summary');
        const showSetup = ref(true);
        const sheetUrl = ref(localStorage.getItem('googleSheetUrl') || '');
        const tempUrl = ref('');
        const isUpdating = ref(false);
        
        // åŒ¯ç‡è¨­å®š (é è¨­ 32.5)
        const exchangeRate = ref(parseFloat(localStorage.getItem('exchangeRate')) || 32.5);
        watch(exchangeRate, (val) => localStorage.setItem('exchangeRate', val));

        const riskParams = ref({ rf: 1.5, beta: 1.0 });

        // è³‡æ–™å„²å­˜
        const transactions = ref(JSON.parse(localStorage.getItem('ledgerData') || '[]'));
        const historyData = ref(JSON.parse(localStorage.getItem('historyData') || '[]'));
        const priceMap = ref(JSON.parse(localStorage.getItem('priceMap') || '{}'));
        
        // è¡¨å–®
        const txForm = ref({ date: new Date().toISOString().split('T')[0], type: 'Buy', category: 'å°è‚¡', ticker: '', price: null, shares: null, amount: null });

        // --- æ ¸å¿ƒé‹ç®—é‚è¼¯ ---
        
        // 1. è¨ˆç®—åº«å­˜ (Holdings)
        const holdings = computed(() => {
            const map = {};
            transactions.value.forEach(tx => {
                if(!tx.ticker) return;
                const t = tx.ticker.toUpperCase();
                // æ¯å€‹æ¨™çš„ç¨ç«‹è¨ˆç®—
                if(!map[t]) map[t] = { ticker: t, category: tx.category || 'å°è‚¡', shares: 0, totalCost: 0 };
                
                if(tx.type === 'Buy') { 
                    map[t].shares += tx.shares; 
                    map[t].totalCost += (tx.price * tx.shares) + (tx.amount||0); 
                } else if(tx.type === 'Sell') { 
                    const avg = map[t].shares ? map[t].totalCost/map[t].shares : 0; 
                    map[t].shares -= tx.shares; 
                    map[t].totalCost -= avg * tx.shares; 
                }
            });

            return Object.values(map).filter(h => h.shares > 0.0001).map(h => {
                // åƒ¹æ ¼å„ªå…ˆé †åº: æ‰‹å‹•è¼¸å…¥ > å ±åƒ¹ API > å¹³å‡æˆæœ¬
                const marketPrice = priceMap.value[h.ticker] || (h.totalCost / h.shares);
                
                // åŒ¯ç‡æ›ç®—
                const isUSD = (h.category === 'ç¾è‚¡' || h.category === 'åŠ å¯†è²¨å¹£');
                const rate = isUSD ? exchangeRate.value : 1;

                const marketValueOriginal = h.shares * marketPrice;
                const marketValueTwd = marketValueOriginal * rate;
                const costTwd = h.totalCost * rate;

                return { 
                    ...h, 
                    avgCost: h.totalCost / h.shares, 
                    currentPrice: marketPrice, 
                    manualPrice: priceMap.value[h.ticker], // ç”¨æ–¼ç¶å®šè¼¸å…¥æ¡†
                    marketValueTwd: marketValueTwd,
                    unrealizedPLTwd: marketValueTwd - costTwd, 
                    returnRate: costTwd ? (((marketValueTwd - costTwd) / costTwd) * 100).toFixed(2) : 0
                };
            }).sort((a,b) => b.marketValueTwd - a.marketValueTwd);
        });

        // 2. è¨ˆç®—ç¸½é¡ (Totals)
        const categoryTotals = computed(() => {
            const totals = {};
            holdings.value.forEach(h => {
                if(!totals[h.category]) totals[h.category] = 0;
                totals[h.category] += h.marketValueTwd;
            });
            totals['ç¾é‡‘'] = cashBalanceTwd.value;
            return totals;
        });

        // ç¾é‡‘é¤˜é¡ (éœ€å€åˆ†å¹£åˆ¥ï¼Œé€™è£¡ç°¡åŒ–ç‚ºå…¨æ›ç®—å°å¹£é¡¯ç¤ºï¼Œå¯¦å‹™ä¸Šå¯æ›´ç´°)
        const cashBalanceTwd = computed(() => {
            return transactions.value.reduce((acc, tx) => {
                const isUSD = (tx.category === 'ç¾è‚¡' || tx.category === 'åŠ å¯†è²¨å¹£');
                const rate = isUSD ? exchangeRate.value : 1;
                return acc + (tx.totalCashFlow * rate);
            }, 0);
        });

        const totalAssetsTwd = computed(() => cashBalanceTwd.value + holdings.value.reduce((sum, h) => sum + h.marketValueTwd, 0));
        
        const totalPrincipalTwd = computed(() => {
            return transactions.value.reduce((acc, tx) => {
                const isUSD = (tx.category === 'ç¾è‚¡' || tx.category === 'åŠ å¯†è²¨å¹£');
                const rate = isUSD ? exchangeRate.value : 1;
                // æœ¬é‡‘ = å…¥é‡‘ - å‡ºé‡‘
                if(tx.type === 'Deposit') return acc + (tx.amount * rate);
                if(tx.type === 'Withdraw') return acc - (tx.amount * rate);
                return acc;
            }, 0);
        });

        const totalUnrealizedPL = computed(() => totalAssetsTwd.value - totalPrincipalTwd.value);
        const totalReturnRate = computed(() => totalPrincipalTwd.value ? ((totalUnrealizedPL.value/totalPrincipalTwd.value)*100).toFixed(2) : 0);
        const reversedTransactions = computed(() => [...transactions.value].reverse());

        // --- é‡åŒ–åˆ†ææ ¸å¿ƒ (Quant Core) ---
        const stats = computed(() => {
            const data = historyData.value;
            // è‹¥æ•¸æ“šå°‘æ–¼ 3 ç­†ï¼Œé¡¯ç¤º N/A
            if (data.length < 3) return { sharpe:'N/A', sortino:'N/A', var95:'N/A', stdDev:'N/A', mdd:'N/A' };

            const returns = [];
            let maxAsset = -Infinity;
            let maxDrawdown = 0;

            for(let i=1; i<data.length; i++) {
                const prev = data[i-1]; 
                const curr = data[i]; 
                
                // ç°¡å–®å ±é…¬ç‡è¨ˆç®— (å¿½ç•¥ç¾é‡‘æµå½±éŸ¿ï¼Œä»¥ç°¡åŒ–è¨ˆç®—)
                // è‹¥è¦ç²¾ç¢ºéœ€æ‰£é™¤ Net Flow: (Assets_t - Assets_t-1 - Flow) / Assets_t-1
                // é€™è£¡å‡è¨­å¿«ç…§é–“ç„¡å¤§é¡å‡ºå…¥é‡‘ï¼Œæˆ–ç›´æ¥è¨ˆç®—æ·¨å€¼æˆé•·
                const r = (curr.assets - prev.assets) / prev.assets;
                returns.push(r);

                // MDD è¨ˆç®—
                if (curr.assets > maxAsset) maxAsset = curr.assets;
                const dd = (maxAsset - curr.assets) / maxAsset;
                if (dd > maxDrawdown) maxDrawdown = dd;
            }

            // çµ±è¨ˆé‹ç®—
            const n = returns.length;
            const avgR = returns.reduce((a,b)=>a+b,0)/n;
            const variance = returns.reduce((a,b) => a + Math.pow(b-avgR, 2), 0)/(n-1);
            const stdDev = Math.sqrt(variance);
            
            // å¹´åŒ– (å‡è¨­æ¯æ—¥å¿«ç…§ï¼Œä¹˜ sqrt(252)ï¼Œè‹¥æ¯é€±å‰‡ 52)
            // é€™è£¡ç°¡å–®å‡è¨­ç‚ºæ—¥è³‡æ–™
            const annStdDev = stdDev * Math.sqrt(252);
            const annReturn = avgR * 252;
            const rf = riskParams.value.rf / 100;

            const sharpe = (annReturn - rf) / annStdDev;

            // Sortino (ä¸‹è¡Œé¢¨éšª)
            const downsideReturns = returns.filter(r => r < 0);
            const downsideVar = downsideReturns.reduce((a,b)=>a+Math.pow(b,2), 0) / n;
            const downsideDev = Math.sqrt(downsideVar) * Math.sqrt(252);
            const sortino = (annReturn - rf) / downsideDev;

            // VaR (æ­·å²æ¨¡æ“¬æ³•)
            const sortedR = [...returns].sort((a,b)=>a-b);
            const var95 = sortedR[Math.floor(n * 0.05)];

            return { 
                sharpe: sharpe.toFixed(2), 
                sortino: isFinite(sortino) ? sortino.toFixed(2) : 'âˆ', 
                var95: (var95*100).toFixed(2), 
                stdDev: (annStdDev*100).toFixed(2),
                mdd: (maxDrawdown*100).toFixed(2)
            };
        });

        // --- åŠŸèƒ½å‡½æ•¸ ---

        function addTransaction() {
            const { date, type, category, ticker, price, shares, amount } = txForm.value;
            if(!date) return;
            
            let cf = 0;
            // ç¾é‡‘æµé‚è¼¯
            if(type==='Buy') cf = -(price*shares + (amount||0));
            else if(type==='Sell') cf = (price*shares - (amount||0));
            else if(type==='Deposit' || type==='Dividend') cf = amount;
            
            transactions.value.push({ 
                date, type, category, 
                ticker: ticker?.toUpperCase(), 
                price, shares, amount, totalCashFlow: cf 
            });
            
            saveData();
            // é‡ç½®è¡¨å–® (ä¿ç•™æ—¥æœŸèˆ‡é¡åˆ¥ï¼Œæ–¹ä¾¿é€£çºŒè¼¸å…¥)
            txForm.value.ticker = ''; txForm.value.price = null; txForm.value.shares = null; txForm.value.amount = null;
            updateCharts();
        }

        // æ‰‹å‹•æ›´æ–°ç¾åƒ¹ (é©ç”¨æ–¼ Crypto / åŸºé‡‘)
        function manualUpdate(stock) {
            if(stock.manualPrice) {
                priceMap.value[stock.ticker] = stock.manualPrice;
                localStorage.setItem('priceMap', JSON.stringify(priceMap.value));
                setTimeout(updateCharts, 100);
            }
        }

        // æ‹æ”å¿«ç…§ (è¨˜éŒ„æ­·å²)
        function takeSnapshot() {
            const today = new Date().toISOString().split('T')[0];
            const snapshot = { date: today, assets: totalAssetsTwd.value, cost: totalPrincipalTwd.value };
            
            // è‹¥ä»Šæ—¥å·²å­˜ï¼Œå‰‡è¦†è“‹
            const idx = historyData.value.findIndex(h => h.date === today);
            if(idx !== -1) historyData.value[idx] = snapshot; 
            else historyData.value.push(snapshot);
            
            historyData.value.sort((a,b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('historyData', JSON.stringify(historyData.value));
            alert('âœ… ä»Šæ—¥è³‡ç”¢å¿«ç…§å·²å„²å­˜ï¼');
            updateCharts();
        }

        // ç”¢ç”Ÿæ¸¬è©¦æ•¸æ“š (Mock Data)
        function generateMockData() {
            if(!confirm('é€™å°‡æœƒç”¢ç”Ÿéå» 30 å¤©çš„éš¨æ©Ÿè³‡ç”¢ç´€éŒ„ä»¥æ¸¬è©¦åœ–è¡¨ï¼Œç¢ºå®šå—ï¼Ÿ')) return;
            
            const mockHistory = [];
            let baseAsset = 1000000;
            let baseCost = 800000;
            
            for(let i=30; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                
                // éš¨æ©Ÿæ³¢å‹•
                const change = (Math.random() - 0.45) * 20000; 
                baseAsset += change;
                
                mockHistory.push({
                    date: dateStr,
                    assets: baseAsset,
                    cost: baseCost
                });
            }
            historyData.value = mockHistory;
            localStorage.setItem('historyData', JSON.stringify(historyData.value));
            alert('ğŸ§ª æ¸¬è©¦æ•¸æ“šå·²ç”Ÿæˆï¼Œè«‹æŸ¥çœ‹é‡åŒ–åˆ†æé é¢ã€‚');
            updateCharts();
        }

        function removeTransaction(idx) { if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†äº¤æ˜“?')) { transactions.value.splice(idx, 1); saveData(); updateCharts(); } }
        function removeHistory(idx) { if(confirm('ç¢ºå®šåˆªé™¤æ­¤æ­·å²ç´€éŒ„?')) { historyData.value.splice(idx, 1); localStorage.setItem('historyData', JSON.stringify(historyData.value)); updateCharts(); } }
        function saveData() { localStorage.setItem('ledgerData', JSON.stringify(transactions.value)); }
        function saveUrl() { if(tempUrl.value) { sheetUrl.value = tempUrl.value; localStorage.setItem('googleSheetUrl', sheetUrl.value); fetchPrices(); } showSetup.value = false; }
        
        function fetchPrices() {
            if(!sheetUrl.value) return;
            isUpdating.value = true;
            Papa.parse(sheetUrl.value, { download: true, header: false, complete: (res) => {
                res.data.forEach(r => { 
                    if(r[0]&&r[1]) { 
                        const k=r[0].toString().trim().toUpperCase(); 
                        const v=parseFloat(r[1].toString().replace(/,/g,'')); 
                        if(!isNaN(v)) priceMap.value[k]=v;
                    } 
                });
                localStorage.setItem('priceMap', JSON.stringify(priceMap.value)); 
                isUpdating.value = false;
                alert('å ±åƒ¹æ›´æ–°å®Œæˆ');
            }});
        }
        function exportAll() {
            const data = { ledger: transactions.value, history: historyData.value };
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type: "application/json"}));
            link.download = "asset_master_backup.json"; link.click();
        }
        function getTypeColor(type) { return { 'Buy':'text-red-400', 'Sell':'text-green-400', 'Deposit':'text-blue-400', 'Dividend':'text-yellow-400' }[type] || 'text-gray-400'; }
        function getCategoryColor(cat) { return { 'ç¾è‚¡':'border-indigo-500', 'å°è‚¡':'border-blue-500', 'åŸºé‡‘':'border-green-500', 'åŠ å¯†è²¨å¹£':'border-purple-500' }[cat] || 'border-gray-500'; }
        function formatNumber(n) { return new Intl.NumberFormat('zh-TW', {maximumFractionDigits:0}).format(n||0); }
        function formatPercent(n) { return ((n||0)*100).toFixed(1) + '%'; }

        // --- åœ–è¡¨ ---
        let chartAlloc, chartHist;
        function initCharts() {
            if(!document.getElementById('allocationChart')) return;
            Chart.defaults.color = '#94a3b8'; Chart.defaults.borderColor = '#334155';
            
            chartAlloc = new Chart(document.getElementById('allocationChart'), {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3b82f6', '#10b981', '#a855f7', '#f59e0b', '#ef4444'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } }, cutout: '70%' }
            });

            chartHist = new Chart(document.getElementById('historyChart'), {
                type: 'line',
                data: { labels: [], datasets: [
                    { label: 'ç¸½è³‡ç”¢ (NAV)', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.4, fill: true, pointRadius: 2 },
                    { label: 'ç¸½æˆæœ¬ (Cost)', data: [], borderColor: '#10b981', borderDash: [5, 5], tension: 0.4, pointRadius: 0 }
                ] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { grid: { color: '#1e293b' } } }, plugins: { legend: { position: 'top', align: 'end' } } }
            });
        }

        function updateCharts() {
            if(!chartAlloc) { setTimeout(initCharts, 500); return; }
            // æ›´æ–°åœ“é¤…åœ–
            const cats = categoryTotals.value;
            chartAlloc.data.labels = Object.keys(cats);
            chartAlloc.data.datasets[0].data = Object.values(cats);
            chartAlloc.update();

            // æ›´æ–°è¶¨å‹¢åœ–
            const src = historyData.value;
            chartHist.data.labels = src.map(h => h.date);
            chartHist.data.datasets[0].data = src.map(h => h.assets);
            chartHist.data.datasets[1].data = src.map(h => h.cost);
            chartHist.update();
        }

        onMounted(() => { if(sheetUrl.value) fetchPrices(); setTimeout(initCharts, 1000); });
        watch([currentTab, exchangeRate], () => setTimeout(updateCharts, 100)); // Tab åˆ‡æ›æˆ–åŒ¯ç‡è®Šå‹•æ™‚é‡ç¹ª
        return { 
            currentTab, showSetup, tempUrl, sheetUrl, isUpdating, 
            transactions, historyData, holdings, categoryTotals, 
            cashBalanceTwd, totalAssetsTwd, totalPrincipalTwd, totalUnrealizedPL, totalReturnRate, reversedTransactions, 
            txForm, riskParams, stats, exchangeRate,
            addTransaction, manualUpdate, takeSnapshot, generateMockData,
            removeTransaction, removeHistory, saveUrl, fetchPrices, exportAll, 
            getTypeColor, getCategoryColor, formatNumber, formatPercent 
        };
    }
}).mount('#app');
</script>
</body>
</html>