<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASSET MASTER v5.0 | ENTJ Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .input-dark { background: #1e293b; border: 1px solid #334155; color: white; }
        .input-dark:focus { border-color: #3b82f6; ring: 2px; outline: none; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .tab-inactive { color: #64748b; }
        .tab-inactive:hover { color: #94a3b8; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

<div id="app" class="h-full flex flex-col">
    
    <header class="glass z-50 flex-none h-16 px-4 flex items-center justify-between">
        <div class="flex items-center gap-6">
            <h1 class="font-bold text-lg tracking-wide flex items-center gap-2">
                <i class="fas fa-cube text-blue-500"></i> ASSET MASTER <span class="text-xs text-gray-500">v5.0</span>
            </h1>
            <nav class="flex gap-6 text-sm font-semibold ml-4">
                <button @click="currentTab='summary'" :class="currentTab==='summary'?'tab-active':'tab-inactive'" class="py-5 px-1"><i class="fas fa-home mr-1"></i> 總覽</button>
                <button @click="currentTab='holdings'" :class="currentTab==='holdings'?'tab-active':'tab-inactive'" class="py-5 px-1"><i class="fas fa-wallet mr-1"></i> 庫存</button>
                <button @click="currentTab='history'" :class="currentTab==='history'?'tab-active':'tab-inactive'" class="py-5 px-1"><i class="fas fa-chart-bar mr-1"></i> 資產變化</button>
                <button @click="currentTab='ledger'" :class="currentTab==='ledger'?'tab-active':'tab-inactive'" class="py-5 px-1"><i class="fas fa-list mr-1"></i> 流水帳</button>
            </nav>
        </div>
        <div class="flex gap-3">
             <button @click="fetchPrices" class="p-2 text-gray-400 hover:text-white" title="更新報價"><i class="fas fa-sync-alt" :class="{'fa-spin': isUpdating}"></i></button>
             <button @click="exportAll" class="p-2 text-gray-400 hover:text-white" title="全備份"><i class="fas fa-save"></i></button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-6 bg-gradient-to-br from-gray-900 to-gray-800">
        <div class="max-w-7xl mx-auto h-full space-y-6">

            <div v-if="currentTab === 'summary'" class="animate-fade-in space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass p-6 rounded-2xl border-l-4 border-blue-500">
                        <h3 class="text-xs font-bold text-gray-400 uppercase">目前總資產 (Total Assets)</h3>
                        <p class="text-4xl font-bold text-white mt-2">${{ formatNumber(totalAssets) }}</p>
                    </div>
                    <div class="glass p-6 rounded-2xl border-l-4 border-emerald-500">
                        <h3 class="text-xs font-bold text-gray-400 uppercase">目前總成本 (Total Cost)</h3>
                        <p class="text-4xl font-bold text-white mt-2">${{ formatNumber(totalPrincipal) }}</p>
                    </div>
                    <div class="glass p-6 rounded-2xl" :class="totalUnrealizedPL >= 0 ? 'border-l-4 border-red-500' : 'border-l-4 border-green-500'">
                        <h3 class="text-xs font-bold text-gray-400 uppercase">未實現損益 (Unrealized P/L)</h3>
                        <p class="text-4xl font-bold mt-2" :class="totalUnrealizedPL >= 0 ? 'text-red-400' : 'text-green-400'">
                            {{ totalUnrealizedPL >= 0 ? '+' : '' }}{{ formatNumber(totalUnrealizedPL) }}
                            <span class="text-lg opacity-70 ml-2">({{ totalReturnRate }}%)</span>
                        </p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-96">
                    <div class="glass p-4 rounded-2xl col-span-1 flex flex-col">
                        <h4 class="text-white font-bold mb-2 text-center">現有配置</h4>
                        <div class="flex-1 relative"><canvas id="allocationChart"></canvas></div>
                    </div>
                    <div class="glass p-4 rounded-2xl col-span-2 flex flex-col">
                        <h4 class="text-white font-bold mb-2">資產歷史走勢 (對應資產變化表)</h4>
                        <div class="flex-1 relative"><canvas id="historyChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'holdings'" class="glass rounded-xl overflow-hidden flex flex-col h-full max-h-[80vh]">
                <div class="p-4 bg-gray-800/50 border-b border-gray-700 flex justify-between">
                    <h3 class="font-bold text-white">庫存明細 (Linked Data)</h3>
                    <span class="text-xs text-gray-500">自動計算自流水帳</span>
                </div>
                <div class="overflow-auto flex-1">
                    <table class="w-full text-left">
                        <thead class="sticky top-0 bg-gray-800 text-xs text-gray-400 uppercase font-semibold">
                            <tr>
                                <th class="p-4">標的</th>
                                <th class="p-4 text-right">股數</th>
                                <th class="p-4 text-right">均價</th>
                                <th class="p-4 text-right">現價</th>
                                <th class="p-4 text-right">市值</th>
                                <th class="p-4 text-right">損益</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm divide-y divide-gray-800">
                            <tr v-for="stock in holdings" :key="stock.ticker" class="hover:bg-white/5">
                                <td class="p-4 font-bold text-white">{{ stock.ticker }}</td>
                                <td class="p-4 text-right font-mono">{{ formatNumber(stock.shares) }}</td>
                                <td class="p-4 text-right font-mono text-gray-400">{{ formatNumber(stock.avgCost) }}</td>
                                <td class="p-4 text-right font-mono font-bold text-yellow-400">{{ formatNumber(stock.currentPrice) }}</td>
                                <td class="p-4 text-right font-mono text-white">{{ formatNumber(stock.marketValue) }}</td>
                                <td class="p-4 text-right font-bold" :class="stock.unrealizedPL >= 0 ? 'text-red-400' : 'text-green-400'">
                                    {{ formatNumber(stock.unrealizedPL) }} <span class="text-xs opacity-70">({{ stock.returnRate }}%)</span>
                                </td>
                            </tr>
                            <tr class="bg-blue-900/10">
                                <td class="p-4 font-bold text-blue-300">現金 (Cash)</td>
                                <td colspan="3"></td>
                                <td class="p-4 text-right font-bold text-blue-300">{{ formatNumber(cashBalance) }}</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-if="currentTab === 'history'" class="flex flex-col md:flex-row gap-6 h-full max-h-[80vh]">
                <div class="w-full md:w-72 glass p-5 rounded-xl h-fit">
                    <h3 class="font-bold text-white mb-4 border-b border-gray-700 pb-2">新增歷史紀錄</h3>
                    <p class="text-xs text-gray-400 mb-4">請定期輸入當下的「總資產」與「總成本」，以繪製資產成長圖。</p>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-500">日期</label>
                            <input v-model="historyForm.date" type="date" class="w-full input-dark p-2 rounded">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">總資產市值</label>
                            <input v-model.number="historyForm.assets" type="number" class="w-full input-dark p-2 rounded">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">總投入成本</label>
                            <input v-model.number="historyForm.cost" type="number" class="w-full input-dark p-2 rounded">
                        </div>
                        <button @click="addHistory" class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded font-bold transition">紀錄</button>
                    </div>
                </div>
                <div class="flex-1 glass rounded-xl overflow-hidden flex flex-col">
                    <div class="p-4 bg-gray-800/50 border-b border-gray-700">
                        <h3 class="font-bold text-white">資產變化表 (Asset History)</h3>
                    </div>
                    <div class="overflow-auto flex-1">
                        <table class="w-full text-left">
                            <thead class="sticky top-0 bg-gray-800 text-xs text-gray-400 uppercase">
                                <tr>
                                    <th class="p-3">日期</th>
                                    <th class="p-3 text-right">總資產</th>
                                    <th class="p-3 text-right">總成本</th>
                                    <th class="p-3 text-right">損益金額</th>
                                    <th class="p-3 text-right">報酬率</th>
                                    <th class="p-3 text-center">刪除</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm divide-y divide-gray-800">
                                <tr v-for="(h, idx) in historyData" :key="idx" class="hover:bg-white/5">
                                    <td class="p-3 text-gray-300">{{ h.date }}</td>
                                    <td class="p-3 text-right text-white font-mono font-bold">{{ formatNumber(h.assets) }}</td>
                                    <td class="p-3 text-right text-gray-400 font-mono">{{ formatNumber(h.cost) }}</td>
                                    <td class="p-3 text-right font-bold" :class="(h.assets-h.cost)>=0?'text-red-400':'text-green-400'">{{ formatNumber(h.assets - h.cost) }}</td>
                                    <td class="p-3 text-right" :class="(h.assets-h.cost)>=0?'text-red-400':'text-green-400'">{{ h.cost?(((h.assets-h.cost)/h.cost)*100).toFixed(2):0 }}%</td>
                                    <td class="p-3 text-center"><button @click="removeHistory(idx)" class="text-gray-600 hover:text-red-500"><i class="fas fa-trash"></i></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'ledger'" class="flex flex-col md:flex-row gap-6 h-full max-h-[80vh]">
                <div class="w-full md:w-72 glass p-5 rounded-xl h-fit">
                    <h3 class="font-bold text-white mb-4 border-b border-gray-700 pb-2">新增交易</h3>
                    <div class="space-y-3">
                        <input v-model="txForm.date" type="date" class="w-full input-dark p-2 rounded">
                        <div class="grid grid-cols-2 gap-2">
                             <select v-model="txForm.type" class="col-span-2 input-dark p-2 rounded">
                                 <option value="Buy">買入 Buy</option>
                                 <option value="Sell">賣出 Sell</option>
                                 <option value="Deposit">入金 Deposit</option>
                                 <option value="Dividend">股息 Dividend</option>
                             </select>
                        </div>
                        <div v-if="['Buy','Sell','Dividend'].includes(txForm.type)">
                            <input v-model="txForm.ticker" placeholder="標的 (如 2330)" class="w-full input-dark p-2 rounded uppercase">
                        </div>
                        <div v-if="['Buy','Sell'].includes(txForm.type)" class="grid grid-cols-2 gap-2">
                            <input v-model.number="txForm.price" type="number" placeholder="單價" class="input-dark p-2 rounded">
                            <input v-model.number="txForm.shares" type="number" placeholder="股數" class="input-dark p-2 rounded">
                        </div>
                        <div>
                             <input v-model.number="txForm.amount" type="number" :placeholder="txForm.type==='Buy'?'手續費':'總金額'" class="w-full input-dark p-2 rounded">
                        </div>
                        <button @click="addTransaction" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold">確認</button>
                    </div>
                </div>
                <div class="flex-1 glass rounded-xl overflow-hidden flex flex-col">
                    <div class="p-4 bg-gray-800/50 border-b border-gray-700">
                        <h3 class="font-bold text-white">交易流水帳 (Ledger)</h3>
                    </div>
                    <div class="overflow-auto flex-1">
                        <table class="w-full text-left">
                            <thead class="sticky top-0 bg-gray-800 text-xs text-gray-400 uppercase">
                                <tr>
                                    <th class="p-3">日期</th>
                                    <th class="p-3">類別</th>
                                    <th class="p-3">標的</th>
                                    <th class="p-3 text-right">價格/股數</th>
                                    <th class="p-3 text-right">現金流</th>
                                    <th class="p-3 text-center">刪除</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm divide-y divide-gray-800">
                                <tr v-for="(tx, idx) in reversedTransactions" :key="idx" class="hover:bg-white/5">
                                    <td class="p-3 text-gray-400">{{ tx.date }}</td>
                                    <td class="p-3 font-bold" :class="getTypeColor(tx.type)">{{ tx.type }}</td>
                                    <td class="p-3 text-white">{{ tx.ticker || '-' }}</td>
                                    <td class="p-3 text-right text-gray-400">{{ tx.price ? `${formatNumber(tx.price)} x ${formatNumber(tx.shares)}` : '-' }}</td>
                                    <td class="p-3 text-right font-mono text-white">{{ formatNumber(tx.totalCashFlow) }}</td>
                                    <td class="p-3 text-center"><button @click="removeTransaction(transactions.length - 1 - idx)" class="text-gray-600 hover:text-red-500"><i class="fas fa-times"></i></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div v-if="!sheetUrl && showSetup" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50">
                <div class="glass p-8 rounded-xl w-96 text-center">
                    <h2 class="text-xl font-bold mb-4">初始化設定</h2>
                    <input v-model="tempUrl" placeholder="Google Sheet CSV Link (可跳過)" class="w-full input-dark p-2 rounded mb-4 text-xs">
                    <button @click="saveUrl" class="w-full bg-blue-600 py-2 rounded text-white font-bold mb-2">確認</button>
                    <button @click="showSetup=false" class="text-xs text-gray-500 underline">暫時跳過，使用手動報價</button>
                </div>
            </div>

        </div>
    </main>
</div>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue;

createApp({
    setup() {
        const currentTab = ref('summary');
        const showSetup = ref(true);
        const sheetUrl = ref(localStorage.getItem('googleSheetUrl') || '');
        const tempUrl = ref('');
        const isUpdating = ref(false);

        // DATA STORE
        const transactions = ref(JSON.parse(localStorage.getItem('ledgerData') || '[]'));
        const historyData = ref(JSON.parse(localStorage.getItem('historyData') || '[]'));
        const priceMap = ref(JSON.parse(localStorage.getItem('priceMap') || '{}'));

        // FORMS
        const txForm = ref({ date: new Date().toISOString().split('T')[0], type: 'Buy', ticker: '', price: null, shares: null, amount: null });
        const historyForm = ref({ date: new Date().toISOString().split('T')[0], assets: null, cost: null });

        // COMPUTED: HOLDINGS
        const holdings = computed(() => {
            const map = {};
            transactions.value.forEach(tx => {
                if(!tx.ticker) return;
                const t = tx.ticker.toUpperCase();
                if(!map[t]) map[t] = { ticker: t, shares: 0, totalCost: 0 };
                if(tx.type === 'Buy') {
                    map[t].shares += tx.shares;
                    map[t].totalCost += (tx.price * tx.shares) + (tx.amount||0);
                } else if(tx.type === 'Sell') {
                    const avg = map[t].shares ? map[t].totalCost/map[t].shares : 0;
                    map[t].shares -= tx.shares;
                    map[t].totalCost -= avg * tx.shares;
                }
            });
            return Object.values(map).filter(h => h.shares > 0).map(h => {
                const curr = priceMap.value[h.ticker] || (h.totalCost/h.shares);
                return {
                    ...h, avgCost: h.totalCost/h.shares, currentPrice: curr,
                    marketValue: h.shares * curr,
                    unrealizedPL: (h.shares * curr) - h.totalCost,
                    returnRate: (((h.shares * curr) - h.totalCost)/h.totalCost*100).toFixed(2)
                };
            }).sort((a,b) => b.marketValue - a.marketValue);
        });

        // COMPUTED: CASH & TOTALS (Real-time)
        const cashBalance = computed(() => transactions.value.reduce((acc, tx) => acc + tx.totalCashFlow, 0));
        const stockValue = computed(() => holdings.value.reduce((sum, h) => sum + h.marketValue, 0));
        
        // Use History Data for "Summary" if available (Latest record), else calculate real-time
        const latestHistory = computed(() => historyData.value.length ? historyData.value[historyData.value.length-1] : null);
        
        const totalAssets = computed(() => cashBalance.value + stockValue.value);
        // Principal calculation from Ledger (Net Deposit)
        const totalPrincipal = computed(() => transactions.value.reduce((acc, tx) => {
             if(tx.type==='Deposit') return acc+tx.amount;
             if(tx.type==='Withdraw') return acc-tx.amount;
             return acc;
        }, 0));

        const totalUnrealizedPL = computed(() => totalAssets.value - totalPrincipal.value);
        const totalReturnRate = computed(() => totalPrincipal.value ? ((totalUnrealizedPL.value/totalPrincipal.value)*100).toFixed(2) : 0);
        
        const reversedTransactions = computed(() => [...transactions.value].reverse());

        // ACTIONS
        function addTransaction() {
            const { date, type, ticker, price, shares, amount } = txForm.value;
            if(!date) return;
            let cf = 0;
            if(type==='Buy') cf = -(price*shares + (amount||0));
            else if(type==='Sell') cf = (price*shares - (amount||0));
            else if(type==='Deposit' || type==='Dividend') cf = amount;
            else if(type==='Withdraw') cf = -amount;

            transactions.value.push({ date, type, ticker: ticker?.toUpperCase(), price, shares, amount, totalCashFlow: cf });
            saveData();
            txForm.value = { ...txForm.value, ticker:'', price:null, shares:null, amount:null }; // Keep date/type
            updateCharts();
        }

        function addHistory() {
            const { date, assets, cost } = historyForm.value;
            if(!date || !assets) return;
            historyData.value.push({ date, assets, cost });
            historyData.value.sort((a,b) => new Date(a.date) - new Date(b.date)); // Keep sorted
            localStorage.setItem('historyData', JSON.stringify(historyData.value));
            historyForm.value.assets = null; historyForm.value.cost = null;
            updateCharts();
        }

        function removeTransaction(idx) {
            if(confirm('刪除?')) { transactions.value.splice(idx, 1); saveData(); updateCharts(); }
        }
        function removeHistory(idx) {
            if(confirm('刪除歷史紀錄?')) { historyData.value.splice(idx, 1); localStorage.setItem('historyData', JSON.stringify(historyData.value)); updateCharts(); }
        }

        function saveData() { localStorage.setItem('ledgerData', JSON.stringify(transactions.value)); }
        
        function saveUrl() {
            if(tempUrl.value) { sheetUrl.value = tempUrl.value; localStorage.setItem('googleSheetUrl', sheetUrl.value); fetchPrices(); }
            showSetup.value = false;
        }

        function fetchPrices() {
            if(!sheetUrl.value) return;
            isUpdating.value = true;
            Papa.parse(sheetUrl.value, {
                download: true, header: false,
                complete: (res) => {
                    res.data.forEach(r => {
                        if(r[0] && r[1]) {
                             const k = r[0].toString().trim().toUpperCase();
                             const v = parseFloat(r[1].toString().replace(/,/g,''));
                             if(!isNaN(v)) { priceMap.value[k] = v; priceMap.value['TPE:'+k] = v; priceMap.value[k.replace('TPE:','')] = v; }
                        }
                    });
                    localStorage.setItem('priceMap', JSON.stringify(priceMap.value));
                    isUpdating.value = false;
                }
            });
        }

        function exportAll() {
            const data = { ledger: transactions.value, history: historyData.value };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "asset_master_backup.json";
            link.click();
        }

        function getTypeColor(type) {
            return { 'Buy':'text-red-400', 'Sell':'text-green-400', 'Deposit':'text-blue-400', 'Dividend':'text-yellow-400' }[type] || 'text-gray-400';
        }
        function formatNumber(n) { return new Intl.NumberFormat('en-US', {maximumFractionDigits:0}).format(n||0); }

        // CHARTS
        let chartAlloc, chartHist;
        function initCharts() {
            if(!document.getElementById('allocationChart')) return;
            Chart.defaults.color = '#94a3b8'; Chart.defaults.borderColor = '#334155';
            
            chartAlloc = new Chart(document.getElementById('allocationChart'), {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });

            chartHist = new Chart(document.getElementById('historyChart'), {
                type: 'bar',
                data: { labels: [], datasets: [
                    { label: '總資產', data: [], backgroundColor: '#3b82f6' },
                    { label: '總成本', data: [], backgroundColor: '#10b981' }
                ] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } } } }
            });
        }

        function updateCharts() {
            if(!chartAlloc) { setTimeout(initCharts, 500); return; }
            
            // Allocation
            const labels = holdings.value.map(h => h.ticker);
            const data = holdings.value.map(h => h.marketValue);
            if(cashBalance.value > 100) { labels.push('Cash'); data.push(cashBalance.value); }
            chartAlloc.data.labels = labels; chartAlloc.data.datasets[0].data = data;
            chartAlloc.update();

            // History (From History Tab Data)
            chartHist.data.labels = historyData.value.map(h => h.date);
            chartHist.data.datasets[0].data = historyData.value.map(h => h.assets);
            chartHist.data.datasets[1].data = historyData.value.map(h => h.cost);
            chartHist.update();
        }

        onMounted(() => {
            if(sheetUrl.value) fetchPrices();
            setTimeout(initCharts, 1000);
        });

        watch(currentTab, () => setTimeout(updateCharts, 100)); // Re-render charts on tab switch

        return {
            currentTab, showSetup, tempUrl, sheetUrl, isUpdating,
            transactions, historyData, holdings, cashBalance,
            totalAssets, totalPrincipal, totalUnrealizedPL, totalReturnRate, reversedTransactions,
            txForm, historyForm,
            addTransaction, addHistory, removeTransaction, removeHistory,
            saveUrl, fetchPrices, exportAll, getTypeColor, formatNumber
        };
    }
}).mount('#app');
</script>
</body>
</html>