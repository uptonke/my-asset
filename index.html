<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資產管理大師 v13.2 | 雲端串接版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Microsoft JhengHei', 'Segoe UI', Roboto, sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); }
        .glass-sim { background: rgba(50, 20, 20, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 100, 100, 0.2); }
        
        .input-dark { background: #1e293b; border: 1px solid #475569; color: white; transition: all 0.2s; }
        .input-dark:focus { border-color: #fbbf24; ring: 2px; outline: none; }
        
        .tab-active { border-bottom: 2px solid #fbbf24; color: #fbbf24; font-weight: bold; text-shadow: 0 0 8px rgba(251, 191, 36, 0.3); }
        .tab-inactive { color: #94a3b8; }
        .tab-inactive:hover { color: #cbd5e1; }
        
        .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); }
        .btn-gold { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .btn-purple { background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; }
        
        .progress-bar-bg { background: #334155; border-radius: 999px; overflow: hidden; height: 8px; }
        .progress-bar-fill { height: 100%; transition: width 0.5s ease; }
        
        .quant-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 0.75rem; padding: 1rem; text-align: center; transition: all 0.2s; position: relative; overflow: hidden; }
        .quant-card:hover { background: rgba(255, 255, 255, 0.05); transform: translateY(-2px); }
        .quant-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; opacity: 0.8; }
        .quant-value { font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.25rem; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        
        .excel-table th { background-color: #1e293b; color: #94a3b8; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; border-bottom: 2px solid #334155; }
        .excel-table td { border-bottom: 1px solid #334155; padding: 0.75rem 1rem; }
        .excel-table tr:hover td { background-color: rgba(255,255,255,0.03); }
        .excel-table tfoot td { background-color: #1e293b; font-weight: bold; border-top: 2px solid #475569; color: #e2e8f0; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm">

<div id="app" class="h-full flex flex-col transition-colors duration-500" :class="isSimMode ? 'bg-[#1a0505]' : 'bg-[#0f172a]'">
    
    <header class="z-50 flex-none h-16 px-6 flex items-center justify-between shadow-lg transition-colors duration-500" :class="isSimMode ? 'glass-sim' : 'glass'">
        <div class="flex items-center gap-6">
            <h1 class="font-bold text-xl tracking-wide flex items-center gap-2 text-white">
                <i class="fas fa-chart-line text-yellow-500"></i> 資產管理大師 
                <span v-if="!isSimMode" class="text-xs bg-yellow-600 px-2 py-0.5 rounded text-black font-bold">v13.2 Feed</span>
                <span v-else class="text-xs bg-red-600 px-2 py-0.5 rounded text-white font-bold animate-pulse">SANDBOX</span>
            </h1>
            
            <div class="hidden md:flex items-center gap-3 bg-slate-800 py-1 px-3 rounded-lg border border-slate-700">
                <span class="text-gray-400 text-xs">USD/TWD:</span>
                <input v-model.number="exchangeRate" type="number" step="0.01" class="w-16 bg-transparent text-center font-mono font-bold text-green-400 focus:outline-none border-b border-gray-600">
            </div>

            <div class="hidden md:flex items-center gap-2 bg-slate-800 py-1 px-3 rounded-lg border border-slate-700 w-64">
                <i class="fab fa-google text-green-500"></i>
                <input v-model="sheetUrl" placeholder="Google Sheet CSV 連結" class="w-full bg-transparent text-xs text-white focus:outline-none placeholder-gray-500">
            </div>

            <nav class="flex gap-6 font-medium ml-4 hidden md:flex">
                <button @click="currentTab='summary'" :class="currentTab==='summary'?'tab-active':'tab-inactive'" class="py-4 px-2 transition"><i class="fas fa-home mr-1"></i> 總覽</button>
                <button @click="currentTab='holdings'" :class="currentTab==='holdings'?'tab-active':'tab-inactive'" class="py-4 px-2 transition"><i class="fas fa-wallet mr-1"></i> 庫存</button>
                <button @click="currentTab='analytics'" :class="currentTab==='analytics'?'tab-active':'tab-inactive'" class="py-4 px-2 transition"><i class="fas fa-brain mr-1"></i> 量化</button>
                <button @click="currentTab='ledger'" :class="currentTab==='ledger'?'tab-active':'tab-inactive'" class="py-4 px-2 transition"><i class="fas fa-list mr-1"></i> 記帳</button>
            </nav>
        </div>
        <div class="flex gap-3 items-center">
             <div class="flex items-center mr-4">
                <span class="text-xs mr-2 font-bold" :class="isSimMode ? 'text-red-400' : 'text-gray-400'">
                    {{ isSimMode ? '歷史模擬' : '真實歷史' }}
                </span>
                <button @click="toggleSimMode" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors focus:outline-none" :class="isSimMode ? 'bg-red-600' : 'bg-gray-600'">
                    <span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform" :class="isSimMode ? 'translate-x-6' : 'translate-x-1'"></span>
                </button>
             </div>
             <button @click="fetchPrices" class="p-2 text-blue-400 hover:text-white transition" title="從 Sheet 更新報價"><i class="fas fa-sync-alt" :class="{'fa-spin': isUpdating}"></i></button>
             <button @click="exportAll" class="p-2 text-green-400 hover:text-white transition" title="備份資料"><i class="fas fa-download"></i></button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 md:p-6 transition-colors duration-500">
        <div class="max-w-7xl mx-auto h-full space-y-6">

            <div v-if="currentTab === 'summary'" class="animate-fade-in space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="glass p-6 rounded-2xl border-t-4 border-yellow-500">
                        <div class="text-xs text-gray-400 font-bold uppercase">投資總市值 (Market Value)</div>
                        <div class="text-3xl font-bold text-white mt-2 font-mono">NT$ {{ formatNumber(totalStockValueTwd) }}</div>
                        <div class="text-xs text-gray-500 mt-2">* 依 Sheet 報價及匯率換算</div>
                    </div>
                    <div class="glass p-6 rounded-2xl border-t-4 border-emerald-500">
                        <div class="text-xs text-gray-400 font-bold uppercase">投資總成本 (Total Cost)</div>
                        <div class="text-3xl font-bold text-white mt-2 font-mono">NT$ {{ formatNumber(totalStockCostTwd) }}</div>
                    </div>
                    <div class="glass p-6 rounded-2xl border-t-4" :class="totalStockUnrealizedPL >= 0 ? 'border-red-500' : 'border-green-500'">
                        <div class="text-xs text-gray-400 font-bold uppercase">未實現損益 (P/L)</div>
                        <div class="text-3xl font-bold mt-2 font-mono" :class="totalStockUnrealizedPL >= 0 ? 'text-red-400' : 'text-green-400'">
                            {{ totalStockUnrealizedPL >= 0 ? '+' : '' }}{{ formatNumber(totalStockUnrealizedPL) }}
                        </div>
                        <div class="text-sm font-bold mt-1" :class="totalStockUnrealizedPL >= 0 ? 'text-red-400' : 'text-green-400'">
                            報酬率: {{ totalStockReturnRate }}%
                        </div>
                    </div>
                    <div class="glass p-6 rounded-2xl border-t-4 border-purple-500 flex flex-col justify-center">
                         <div class="text-xs text-gray-400 font-bold uppercase mb-3">投資組合權重</div>
                         <div class="space-y-3">
                             <div v-for="(val, cat) in categoryTotals" :key="cat">
                                 <div class="flex justify-between text-xs mb-1">
                                     <span class="text-white">{{ cat }}</span>
                                     <span class="font-mono text-gray-300">{{ formatPercent(val / totalStockValueTwd) }}</span>
                                 </div>
                                 <div class="progress-bar-bg">
                                     <div class="progress-bar-fill" :style="{ width: ((val / totalStockValueTwd) * 100) + '%', backgroundColor: getCategoryColorCode(cat) }"></div>
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-96">
                    <div class="glass p-5 rounded-2xl col-span-1 flex flex-col">
                        <h4 class="text-white font-bold mb-4 border-l-4 border-yellow-500 pl-3">資產配置</h4>
                        <div class="flex-1 relative">
                            <canvas id="allocationChart"></canvas>
                        </div>
                    </div>
                    <div class="glass p-5 rounded-2xl col-span-2 flex flex-col">
                        <h4 class="text-white font-bold mb-4 border-l-4 border-emerald-500 pl-3">
                            淨值成長趨勢 (NAV)
                        </h4>
                        <div class="flex-1 relative">
                            <canvas id="historyChart"></canvas>
                             <div v-if="displayHistory.length < 2" class="absolute inset-0 flex items-center justify-center text-gray-500 text-xs bg-gray-900/50 rounded-lg">
                                <div class="text-center">
                                    <p class="text-lg mb-2"><i class="fas fa-chart-line text-gray-600 text-4xl"></i></p>
                                    <p>Waiting for Data</p>
                                    <p class="mt-1">請開始投資</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'holdings'" class="flex flex-col h-full max-h-[85vh] space-y-4 animate-fade-in">
                <div class="glass rounded-xl overflow-hidden flex flex-col flex-1">
                    <div class="p-4 bg-gray-800/50 border-b border-gray-700 flex justify-between items-center">
                        <h3 class="font-bold text-white"><i class="fas fa-table text-yellow-500 mr-2"></i>投資組合明細表 (TWD)</h3>
                        <div class="text-xs text-gray-400">
                             <span v-if="lastUpdate" class="text-green-400 mr-2">上次更新: {{ lastUpdate }}</span>
                             * 系統自動比對 Sheet 中的 Ticker 欄位
                        </div>
                    </div>
                    <div class="overflow-auto flex-1 p-0">
                        <table class="w-full text-left whitespace-nowrap excel-table">
                            <thead>
                                <tr>
                                    <th class="pl-6">資產類別</th>
                                    <th>標的代號</th>
                                    <th class="text-right">持有股數</th>
                                    <th class="text-right">均價 (TWD)</th>
                                    <th class="text-right">現價 (TWD)</th>
                                    <th class="text-right">投資成本 (TWD)</th>
                                    <th class="text-right">市值 (TWD)</th>
                                    <th class="text-right">未實現損益</th>
                                    <th class="text-right">報酬率</th>
                                    <th class="text-right pr-6">權重</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">
                                <tr v-for="stock in holdings" :key="stock.ticker">
                                    <td class="pl-6">
                                        <span class="px-2 py-0.5 rounded text-[10px] border" :class="getCategoryBadgeClass(stock.category)">{{ stock.category }}</span>
                                    </td>
                                    <td class="font-bold text-white">
                                        {{ stock.ticker }}
                                        <span v-if="stock.isUSD" class="text-[10px] text-gray-500 ml-1">USD</span>
                                    </td>
                                    <td class="text-right font-mono text-gray-300">{{ formatNumber(stock.shares) }}</td>
                                    <td class="text-right font-mono text-gray-400">{{ formatNumber(stock.avgCostTwd) }}</td>
                                    <td class="text-right font-mono font-bold text-yellow-400">
                                        <span v-if="!stock.manualPrice">{{ formatNumber(stock.currentPriceTwd) }}</span>
                                        <input v-else v-model.number="stock.manualPrice" @change="manualUpdate(stock)" class="w-20 bg-transparent text-right outline-none border-b border-gray-600 text-yellow-400">
                                    </td>
                                    <td class="text-right font-mono text-gray-500">{{ formatNumber(stock.totalCostTwd) }}</td>
                                    <td class="text-right font-mono text-white font-bold">{{ formatNumber(stock.marketValueTwd) }}</td>
                                    <td class="text-right font-bold" :class="stock.unrealizedPLTwd >= 0 ? 'text-red-400' : 'text-green-400'">
                                        {{ formatNumber(stock.unrealizedPLTwd) }}
                                    </td>
                                    <td class="text-right font-bold" :class="stock.returnRate >= 0 ? 'text-red-400' : 'text-green-400'">
                                        {{ stock.returnRate }}%
                                    </td>
                                    <td class="text-right pr-6 font-mono text-blue-300">
                                        {{ formatPercent(stock.marketValueTwd / totalStockValueTwd) }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'analytics'" class="flex flex-col h-full space-y-4 animate-fade-in">
                <div class="p-5 rounded-xl flex flex-wrap items-center justify-between gap-4 border transition-colors duration-500" :class="isSimMode ? 'glass-sim border-red-900/50' : 'glass border-white/5'">
                    <div>
                        <h3 class="font-bold text-white text-lg flex items-center gap-2">
                            <i class="fas fa-brain" :class="isSimMode ? 'text-red-500' : 'text-yellow-500'"></i> 
                            量化風險分析 (Quant)
                            <span v-if="isSimMode" class="text-xs bg-red-600 px-2 rounded text-white ml-2">SIMULATION</span>
                        </h3>
                    </div>
                    <div class="flex gap-4 items-center">
                        <div class="flex items-center gap-2 text-xs mr-2">
                             <label class="text-gray-400">Rf (%):</label>
                             <input v-model.number="riskParams.rf" type="number" step="0.1" class="w-12 input-dark p-1 rounded text-center">
                             <label class="text-gray-400">Beta:</label>
                             <input v-model.number="riskParams.beta" type="number" step="0.1" class="w-12 input-dark p-1 rounded text-center">
                        </div>
                        
                        <button @click="openMonteCarlo" class="btn-purple px-4 py-2 rounded font-bold text-xs flex items-center gap-2 shadow-lg hover:shadow-purple-500/50 transition transform hover:scale-105">
                            <i class="fas fa-random"></i> 蒙地卡羅 (MC)
                        </button>

                        <button v-if="isSimMode" @click="generateMonthlyMockData" class="text-red-300 hover:text-white text-xs border border-red-500/50 bg-red-900/20 px-3 py-2 rounded transition animate-pulse">
                            <i class="fas fa-dice mr-1"></i> 重刷數據
                        </button>
                        <button v-if="!isSimMode" @click="showHistoryModal = true" class="text-blue-400 hover:text-white text-xs border border-blue-500/50 px-3 py-2 rounded transition">
                            <i class="fas fa-edit mr-1"></i> 補登紀錄
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="quant-card"><div class="quant-label text-blue-400">TWR (時間加權)</div><div class="quant-value text-white">{{ stats.twr }}%</div></div>
                    <div class="quant-card"><div class="quant-label text-blue-400">MWR (內部報酬)</div><div class="quant-value text-white">{{ stats.mwr }}%</div></div>
                    <div class="quant-card"><div class="quant-label text-yellow-400">夏普 (Sharpe)</div><div class="quant-value text-white">{{ stats.sharpe }}%</div></div>
                    <div class="quant-card"><div class="quant-label text-yellow-400">索提諾 (Sortino)</div><div class="quant-value text-white">{{ stats.sortino }}%</div></div>
                    <div class="quant-card"><div class="quant-label text-yellow-400">崔娜 (Treynor)</div><div class="quant-value text-white">{{ stats.treynor }}%</div></div>
                    <div class="quant-card"><div class="quant-label text-gray-400">標準差 (StdDev)</div><div class="quant-value text-white">{{ stats.stdDev }}%</div></div>
                    <div class="quant-card"><div class="quant-label text-red-400">VaR (95%)</div><div class="quant-value text-white">{{ stats.var95 }}%</div></div>
                    <div class="quant-card"><div class="quant-label text-red-400">CVaR (Expected Loss)</div><div class="quant-value text-white">{{ stats.cvar95 }}%</div></div>
                    <div class="quant-card"><div class="quant-label text-purple-400">偏度 (Skewness)</div><div class="quant-value text-white">{{ stats.skew }}</div></div>
                    <div class="quant-card"><div class="quant-label text-purple-400">峭度 (Kurtosis)</div><div class="quant-value text-white">{{ stats.kurt }}</div></div>
                </div>

                 <div class="flex-1 glass rounded-xl overflow-hidden flex flex-col">
                    <div class="overflow-auto flex-1">
                        <table class="w-full text-left whitespace-nowrap">
                            <thead class="sticky top-0 bg-[#0f172a] text-xs text-gray-400 uppercase font-semibold">
                                <tr>
                                    <th class="p-3 pl-6">日期</th>
                                    <th class="p-3 text-right">總資產 (NAV)</th>
                                    <th class="p-3 text-right">總成本 (Cost)</th>
                                    <th class="p-3 text-right">週期報酬 (Return)</th>
                                    <th class="p-3 text-center" v-if="!isSimMode">動作</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm divide-y divide-white/5">
                                <tr v-for="(h, idx) in enrichedHistory" :key="h.date" class="hover:bg-white/5">
                                    <td class="p-3 pl-6 font-mono text-blue-300">{{ h.date }}</td>
                                    <td class="p-3 text-right font-mono text-white font-bold">{{ formatNumber(h.assets) }}</td>
                                    <td class="p-3 text-right font-mono text-gray-500">{{ formatNumber(h.cost) }}</td>
                                    <td class="p-3 text-right font-mono" :class="h.dailyReturn >= 0 ? 'text-red-400' : 'text-green-400'">
                                        {{ h.dailyReturn ? (h.dailyReturn * 100).toFixed(2) + '%' : '-' }}
                                    </td>
                                    <td class="p-3 text-center" v-if="!isSimMode">
                                        <button @click="removeHistoryByDate(h.date)" class="text-gray-600 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                 </div>
            </div>

            <div v-if="currentTab === 'ledger'" class="flex flex-col md:flex-row gap-6 h-full max-h-[85vh]">
                 <div class="w-full md:w-80 glass p-5 rounded-xl h-fit space-y-4">
                    <h3 class="font-bold text-white text-lg border-b border-gray-700 pb-2">新增交易 (TWD)</h3>
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">1. 資產類別</label>
                        <div class="grid grid-cols-2 gap-2">
                             <button @click="txForm.category='美股'" :class="txForm.category==='美股'?'bg-yellow-600 text-black font-bold':'bg-gray-700 text-gray-400'" class="p-2 rounded text-xs transition">美股</button>
                             <button @click="txForm.category='台股'" :class="txForm.category==='台股'?'bg-blue-600 text-white':'bg-gray-700 text-gray-400'" class="p-2 rounded text-xs transition">台股</button>
                             <button @click="txForm.category='基金'" :class="txForm.category==='基金'?'bg-green-600 text-white':'bg-gray-700 text-gray-400'" class="p-2 rounded text-xs transition">基金</button>
                             <button @click="txForm.category='加密貨幣'" :class="txForm.category==='加密貨幣'?'bg-purple-600 text-white':'bg-gray-700 text-gray-400'" class="p-2 rounded text-xs transition">加密貨幣</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">2. 交易內容</label>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <input v-model="txForm.date" type="date" class="input-dark p-2 rounded text-xs col-span-2">
                            <select v-model="txForm.type" class="input-dark p-2 rounded text-xs col-span-2">
                                <option value="Buy">買入 (Buy)</option>
                                <option value="Sell">賣出 (Sell)</option>
                                <option value="Deposit">入金 (Deposit)</option>
                                <option value="Dividend">股息 (Dividend)</option>
                            </select>
                        </div>
                        <input v-model="txForm.ticker" placeholder="代號 / 名稱 (如 AAPL)" class="w-full input-dark p-2 rounded text-xs uppercase mb-2">
                        <div v-if="['Buy','Sell'].includes(txForm.type)">
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div><input v-model.number="txForm.price" type="number" placeholder="台幣單價" class="w-full input-dark p-2 rounded text-xs"></div>
                                <div><input v-model.number="txForm.shares" type="number" placeholder="股數" class="w-full input-dark p-2 rounded text-xs"></div>
                            </div>
                            <div class="text-xs text-right text-gray-400 font-mono">
                                總金額: <span class="text-white font-bold">{{ formatNumber((txForm.price || 0) * (txForm.shares || 0)) }}</span> TWD
                            </div>
                        </div>
                        <div v-if="['Deposit','Dividend'].includes(txForm.type)">
                             <input v-model.number="txForm.amount" type="number" placeholder="總金額 (TWD)" class="w-full input-dark p-2 rounded text-xs">
                        </div>
                    </div>
                    <button @click="addTransaction" class="w-full btn-primary text-white rounded-lg font-bold text-sm py-3 shadow-lg">確認送出 (TWD)</button>
                 </div>
                 <div class="flex-1 glass rounded-xl overflow-hidden flex flex-col">
                    <div class="p-4 bg-gray-800/50 border-b border-gray-700">
                        <h3 class="font-bold text-white">交易流水帳 (TWD)</h3>
                    </div>
                    <div class="overflow-auto flex-1">
                        <table class="w-full text-left">
                            <thead class="sticky top-0 bg-[#0f172a] text-xs text-gray-400 uppercase font-semibold">
                                <tr><th class="p-3">日期</th><th class="p-3">類別</th><th class="p-3">名稱</th><th class="p-3 text-right">現金流 (TWD)</th><th class="p-3"></th></tr>
                            </thead>
                            <tbody class="text-sm divide-y divide-white/5">
                                <tr v-for="(tx, idx) in reversedTransactions" :key="idx" class="hover:bg-white/5">
                                    <td class="p-3 text-gray-400">{{ tx.date }}</td>
                                    <td class="p-3 font-bold" :class="getTypeColor(tx.type)">{{ tx.type }}</td>
                                    <td class="p-3 text-white">{{ tx.ticker || '-' }}</td>
                                    <td class="p-3 text-right font-mono text-white">{{ formatNumber(tx.totalCashFlow) }}</td>
                                    <td class="p-3 text-center"><button @click="removeTransaction(transactions.length - 1 - idx)" class="text-gray-600 hover:text-red-500"><i class="fas fa-times"></i></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                 </div>
            </div>

            <div v-if="showHistoryModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-[100]">
                <div class="glass p-6 rounded-xl w-full max-w-lg">
                    <h3 class="text-lg font-bold text-white mb-4">補登 / 編輯歷史資料 (月結)</h3>
                    <div class="space-y-3 mb-6">
                        <div class="flex gap-2">
                            <input v-model="historyForm.date" type="date" class="input-dark p-2 rounded flex-1">
                            <input v-model.number="historyForm.assets" type="number" placeholder="當日總資產 (TWD)" class="input-dark p-2 rounded flex-1">
                            <input v-model.number="historyForm.cost" type="number" placeholder="當日總成本 (TWD)" class="input-dark p-2 rounded flex-1">
                        </div>
                        <button @click="addHistoryRecord" class="w-full btn-gold text-black py-2 rounded font-bold">新增紀錄</button>
                    </div>
                    <button @click="showHistoryModal=false" class="w-full bg-gray-700 py-2 rounded text-white">關閉</button>
                </div>
            </div>

            <div v-if="showMCModal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[100]">
                <div class="glass p-6 rounded-xl w-full max-w-4xl h-[80vh] flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i class="fas fa-random text-purple-400"></i> 蒙地卡羅未來模擬 (Monte Carlo)
                        </h3>
                        <div class="text-xs text-gray-400">
                             Vol: <span class="text-white font-bold">{{ mcParams.vol }}%</span> | Mean: <span class="text-white font-bold">{{ mcParams.mean }}%</span>
                        </div>
                    </div>
                    <div class="flex-1 bg-gray-900 rounded-xl relative p-4 mb-4 border border-gray-700">
                        <canvas id="mcChart"></canvas>
                    </div>
                    <div class="flex justify-between items-center">
                         <div class="text-xs text-gray-500">* 模擬 100 條 GBM 路徑 (1 Year)</div>
                        <button @click="showMCModal=false" class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded text-white font-bold transition">關閉</button>
                    </div>
                </div>
            </div>

        </div>
    </main>
</div>

<script>
const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

createApp({
    setup() {
        const currentTab = ref('summary');
        const showHistoryModal = ref(false);
        const showMCModal = ref(false);
        const isUpdating = ref(false);
        const isSimMode = ref(false);
        const lastUpdate = ref(null);
        
        const exchangeRate = ref(parseFloat(localStorage.getItem('exchangeRate')) || 32.5);
        // Sheet URL Persistence
        const sheetUrl = ref(localStorage.getItem('sheetUrl') || '');

        watch(exchangeRate, (val) => localStorage.setItem('exchangeRate', val));
        watch(sheetUrl, (val) => localStorage.setItem('sheetUrl', val));

        const riskParams = ref({ rf: 1.5, beta: 1.0 });
        const transactions = ref(JSON.parse(localStorage.getItem('ledgerData') || '[]'));
        const realHistoryData = ref(JSON.parse(localStorage.getItem('historyData') || '[]'));
        const mockHistoryData = ref([]);
        const priceMap = ref(JSON.parse(localStorage.getItem('priceMap') || '{}'));
        
        const txForm = ref({ date: new Date().toISOString().split('T')[0], type: 'Buy', category: '美股', ticker: '', price: null, shares: null, amount: null });
        const historyForm = ref({ date: new Date().toISOString().split('T')[0], assets: null, cost: null });
        const mcParams = ref({ vol: 0, mean: 0 });

        const displayHistory = computed(() => isSimMode.value ? mockHistoryData.value : realHistoryData.value);

        function toggleSimMode() {
            isSimMode.value = !isSimMode.value;
            if (isSimMode.value && mockHistoryData.value.length === 0) generateMonthlyMockData();
            updateCharts();
        }

        // --- NEW: Google Sheet Fetcher Logic ---
        async function fetchPrices() {
            if (!sheetUrl.value) { alert('請先在上方輸入 Google Sheet CSV 網址！\n(檔案 -> 發布到網路 -> 選擇 CSV)'); return; }
            isUpdating.value = true;
            try {
                // Fetch the CSV directly
                const response = await fetch(sheetUrl.value);
                if (!response.ok) throw new Error('Network Error');
                const csvText = await response.text();
                
                // Parse CSV
                Papa.parse(csvText, {
                    header: true,
                    complete: (results) => {
                        let count = 0;
                        results.data.forEach(row => {
                            // Match Columns: Ticker, Price
                            if (row.Ticker && row.Price) {
                                const t = row.Ticker.toUpperCase().trim();
                                const p = parseFloat(row.Price);
                                if (!isNaN(p)) {
                                    priceMap.value[t] = p;
                                    count++;
                                }
                            }
                        });
                        localStorage.setItem('priceMap', JSON.stringify(priceMap.value));
                        lastUpdate.value = new Date().toLocaleTimeString();
                        isUpdating.value = false;
                        updateCharts(); // Refresh UI
                        alert(`成功更新 ${count} 檔報價！`);
                    },
                    error: (err) => {
                        console.error(err);
                        alert('CSV 解析失敗，請檢查格式是否為 Ticker, Price');
                        isUpdating.value = false;
                    }
                });
            } catch (e) {
                console.error(e);
                alert('抓取失敗！請確認網址是否正確，且已發布為 "CSV" 格式。\n(可能有 CORS 限制，建議使用 Chrome)');
                isUpdating.value = false;
            }
        }

        const holdings = computed(() => {
            const map = {};
            transactions.value.forEach(tx => {
                if(!tx.ticker) return;
                const t = tx.ticker.toUpperCase();
                if(!map[t]) map[t] = { ticker: t, category: tx.category || '台股', shares: 0, totalCostTwd: 0 };
                if(tx.type === 'Buy') { map[t].shares += tx.shares; map[t].totalCostTwd += Math.abs(tx.totalCashFlow); }
                else if(tx.type === 'Sell') { 
                    const avgCost = map[t].shares ? map[t].totalCostTwd / map[t].shares : 0; 
                    map[t].shares -= tx.shares; map[t].totalCostTwd -= avgCost * tx.shares; 
                }
            });
            return Object.values(map).filter(h => h.shares > 0.0001).map(h => {
                const rawPrice = priceMap.value[h.ticker]; 
                const isUSD = (h.category === '美股' || h.category === '加密貨幣');
                const estimatedCurrentPriceNative = rawPrice || (h.totalCostTwd / h.shares / (isUSD ? exchangeRate.value : 1));
                const currentPriceTwd = estimatedCurrentPriceNative * (isUSD ? exchangeRate.value : 1);
                const mvTwd = h.shares * currentPriceTwd;
                return { 
                    ...h, isUSD, avgCostTwd: h.totalCostTwd / h.shares, currentPriceTwd: currentPriceTwd, manualPrice: rawPrice,
                    marketValueTwd: mvTwd, unrealizedPLTwd: mvTwd - h.totalCostTwd, 
                    returnRate: h.totalCostTwd ? (((mvTwd - h.totalCostTwd)/h.totalCostTwd)*100).toFixed(2) : 0 
                };
            }).sort((a,b) => b.marketValueTwd - a.marketValueTwd);
        });

        const categoryTotals = computed(() => {
            const totals = {};
            holdings.value.forEach(h => { if(!totals[h.category]) totals[h.category]=0; totals[h.category]+=h.marketValueTwd; });
            return totals;
        });

        const cashBalanceTwd = computed(() => transactions.value.reduce((acc, tx) => acc + tx.totalCashFlow, 0));
        const totalStockValueTwd = computed(() => holdings.value.reduce((sum, h) => sum + h.marketValueTwd, 0));
        const totalStockCostTwd = computed(() => holdings.value.reduce((sum, h) => sum + h.totalCostTwd, 0));
        const totalStockUnrealizedPL = computed(() => totalStockValueTwd.value - totalStockCostTwd.value);
        const totalStockReturnRate = computed(() => totalStockCostTwd.value ? ((totalStockUnrealizedPL.value/totalStockCostTwd.value)*100).toFixed(2) : 0);
        const reversedTransactions = computed(() => [...transactions.value].reverse());

        const enrichedHistory = computed(() => {
            const sorted = [...displayHistory.value].sort((a,b) => new Date(a.date) - new Date(b.date));
            return sorted.map((item, index) => {
                let dailyReturn = null;
                if (index > 0) {
                    const prev = sorted[index - 1];
                    const netFlow = item.cost - prev.cost;
                    if (prev.assets > 0) dailyReturn = (item.assets - prev.assets - netFlow) / prev.assets;
                }
                return { ...item, dailyReturn };
            }).reverse();
        });

        const stats = computed(() => {
            const data = displayHistory.value;
            const empty = { twr:'-', mwr:'-', sharpe:'-', sortino:'-', treynor:'-', var95:'-', cvar95:'-', skew:'-', kurt:'-', stdDev:'-' };
            if (data.length < 3) return empty;
            
            const sorted = [...data].sort((a,b) => new Date(a.date) - new Date(b.date));
            const returns = []; 
            for(let i=1; i<sorted.length; i++) {
                const prev = sorted[i-1]; const curr = sorted[i];
                const netFlow = curr.cost - prev.cost; 
                if (prev.assets > 0) returns.push((curr.assets - prev.assets - netFlow) / prev.assets);
            }
            if (returns.length < 2) return empty;

            const twr = returns.reduce((acc, r) => acc * (1 + r), 1) - 1;
            const startV = sorted[0].assets;
            const endV = sorted[sorted.length-1].assets;
            const totalFlows = sorted[sorted.length-1].cost - sorted[0].cost;
            const mwr = (endV - startV - totalFlows) / (startV + 0.5 * totalFlows);

            const n = returns.length;
            const avgR = returns.reduce((a,b)=>a+b,0)/n;
            const variance = returns.reduce((a,b) => a + Math.pow(b-avgR, 2), 0)/(n-1);
            const stdDev = Math.sqrt(variance);
            const annStdDev = stdDev * Math.sqrt(12);

            const m3 = returns.reduce((a,b) => a + Math.pow(b-avgR, 3), 0) / n;
            const skew = m3 / Math.pow(stdDev, 3);
            const m4 = returns.reduce((a,b) => a + Math.pow(b-avgR, 4), 0) / n;
            const kurt = (m4 / Math.pow(stdDev, 4)) - 3;

            const annReturn = avgR * 12;
            const rf = riskParams.value.rf / 100;
            const beta = riskParams.value.beta;
            const sharpe = ((annReturn - rf) / (annStdDev || 1)) * 100;
            const treynor = ((annReturn - rf) / (beta || 1)) * 100;

            const downside = returns.filter(r=>r<0);
            const downsideVar = downside.length > 0 ? downside.reduce((a,b)=>a+Math.pow(b,2),0)/n : 0;
            const sortino = ((annReturn - rf) / (Math.sqrt(downsideVar) * Math.sqrt(12))) * 100;

            const sortedR = [...returns].sort((a,b)=>a-b);
            const idx95 = Math.floor(n * 0.05);
            const var95 = sortedR[idx95] || 0;
            const tailLosses = sortedR.slice(0, idx95+1);
            const cvar95 = tailLosses.length > 0 ? tailLosses.reduce((a,b)=>a+b,0)/tailLosses.length : var95;
            
            mcParams.value = { vol: (annStdDev*100).toFixed(2), mean: (annReturn*100).toFixed(2) };

            return { 
                twr: (twr*100).toFixed(2), mwr: (mwr*100).toFixed(2),
                sharpe: sharpe.toFixed(2), sortino: isFinite(sortino)?sortino.toFixed(2):'∞', treynor: isFinite(treynor)?treynor.toFixed(2):'∞',
                var95: (var95*100).toFixed(2), cvar95: (cvar95*100).toFixed(2),
                stdDev: (annStdDev*100).toFixed(2), skew: skew.toFixed(2), kurt: kurt.toFixed(2)
            };
        });

        function openMonteCarlo() {
            if(displayHistory.value.length < 5) { alert('歷史數據不足 (Need History)'); return; }
            showMCModal.value = true;
            nextTick(runMonteCarlo);
        }

        function runMonteCarlo() {
            const ctx = document.getElementById('mcChart');
            if(!ctx) return;
            const annualMean = parseFloat(mcParams.value.mean) / 100;
            const annualVol = parseFloat(mcParams.value.vol) / 100;
            const startPrice = totalStockValueTwd.value || 100000;
            const steps = 252; const dt = 1/252; const sims = 100;
            const datasets = [];
            for(let s=0; s<sims; s++) {
                const data = [startPrice];
                let current = startPrice;
                for(let t=1; t<=steps; t++) {
                    const u1 = Math.random(); const u2 = Math.random();
                    const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
                    const drift = (annualMean - 0.5 * annualVol * annualVol) * dt;
                    const shock = annualVol * Math.sqrt(dt) * z;
                    current = current * Math.exp(drift + shock);
                    if(t % 5 === 0) data.push(current);
                }
                datasets.push({ data: data, borderColor: s===0 ? '#f59e0b' : 'rgba(139, 92, 246, 0.15)', borderWidth: s===0 ? 2 : 1, pointRadius: 0, fill: false });
            }
            if(window.mcChartInstance) window.mcChartInstance.destroy();
            window.mcChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: Array.from({length: Math.ceil(steps/5)+1}, (_, i) => i), datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: '未來一年模擬路徑 (100 Paths)', color: 'white' } }, scales: { x: { display: false }, y: { grid: { color: '#334155' } } } }
            });
        }

        function addTransaction() {
            const { date, type, category, ticker, price, shares, amount } = txForm.value;
            if(!date) return;
            let cf = 0;
            if(type === 'Buy') { if(!shares) return; cf = -(price * shares); }
            else if(type === 'Sell') { if(!shares) return; cf = (price * shares); }
            else cf = amount || 0;
            transactions.value.push({ date, type, category, ticker: ticker?.toUpperCase(), price, shares, amount, totalCashFlow: cf });
            saveData();
            txForm.value.ticker = ''; txForm.value.price = null; txForm.value.shares = null; txForm.value.amount = null;
            updateCharts();
        }

        function addHistoryRecord() {
            if(isSimMode.value) { alert('沙盒模式無法手動補登'); return; }
            const { date, assets, cost } = historyForm.value;
            if(!date || !assets) return;
            const idx = realHistoryData.value.findIndex(h => h.date === date);
            if(idx !== -1) realHistoryData.value[idx] = { date, assets, cost };
            else realHistoryData.value.push({ date, assets, cost });
            realHistoryData.value.sort((a,b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('historyData', JSON.stringify(realHistoryData.value));
            historyForm.value.assets = null; historyForm.value.cost = null;
            updateCharts();
        }

        function generateMonthlyMockData() {
            const mock = [];
            let base = 1000000; let cost = 800000;
            for(let i=24; i>=0; i--) {
                const d = new Date(); d.setMonth(d.getMonth() - i); d.setDate(28);
                let noise = (Math.random()-0.48)*0.10; 
                if (Math.random() > 0.95) noise = -0.15;
                base = base * (1 + noise);
                if(i%3===0) { cost += 50000; base += 50000; }
                mock.push({ date: d.toISOString().split('T')[0], assets: Math.round(base), cost: cost });
            }
            mockHistoryData.value = mock;
            if(!isSimMode.value) toggleSimMode();
            else updateCharts();
        }

        function manualUpdate(stock) { 
            if(stock.manualPrice) { 
                priceMap.value[stock.ticker] = stock.manualPrice; 
                localStorage.setItem('priceMap', JSON.stringify(priceMap.value)); 
                setTimeout(updateCharts, 100); 
            } 
        }
        function removeTransaction(idx) { if(confirm('刪除?')) { transactions.value.splice(idx, 1); saveData(); updateCharts(); } }
        function removeHistoryByDate(date) { 
            if(isSimMode.value) return;
            if(confirm('刪除?')) { 
                realHistoryData.value = realHistoryData.value.filter(h=>h.date!==date); 
                localStorage.setItem('historyData', JSON.stringify(realHistoryData.value)); 
                updateCharts(); 
            } 
        }
        function saveData() { localStorage.setItem('ledgerData', JSON.stringify(transactions.value)); }
        function exportAll() { const data = { ledger: transactions.value, history: realHistoryData.value }; const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type: "application/json"})); link.download = "asset_master_backup.json"; link.click(); }
        function getTypeColor(type) { return { 'Buy':'text-red-400', 'Sell':'text-green-400', 'Deposit':'text-blue-400', 'Dividend':'text-yellow-400' }[type] || 'text-gray-400'; }
        function getCategoryBadgeClass(cat) { return { '美股':'bg-yellow-900 text-yellow-300 border-yellow-600', '台股':'bg-blue-900 text-blue-300 border-blue-700', '基金':'bg-green-900 text-green-300 border-green-700', '加密貨幣':'bg-purple-900 text-purple-300 border-purple-700' }[cat] || 'bg-gray-800 text-gray-400'; }
        function getCategoryColorCode(cat) { return { '美股':'#f59e0b', '台股':'#3b82f6', '基金':'#10b981', '加密貨幣':'#a855f7' }[cat] || '#94a3b8'; }
        function formatNumber(n) { return new Intl.NumberFormat('zh-TW', {maximumFractionDigits:0}).format(n||0); }
        function formatPercent(n) { return ((n||0)*100).toFixed(1) + '%'; }

        let chartAlloc, chartHist;
        function initCharts() {
            const allocCtx = document.getElementById('allocationChart');
            const histCtx = document.getElementById('historyChart');
            if(chartAlloc) { chartAlloc.destroy(); chartAlloc = null; }
            if(chartHist) { chartHist.destroy(); chartHist = null; }
            Chart.defaults.color = '#94a3b8'; Chart.defaults.borderColor = '#334155';
            
            if (allocCtx) chartAlloc = new Chart(allocCtx, { type: 'doughnut', data: { labels: [], datasets: [{ data: [], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } }, cutout: '70%' } });
            
            if (histCtx) {
                const lineColor = isSimMode.value ? '#ef4444' : '#3b82f6';
                const areaColor = isSimMode.value ? 'rgba(239, 68, 68, 0.1)' : 'rgba(59,130,246,0.1)';
                chartHist = new Chart(histCtx, { 
                    type: 'line', 
                    data: { 
                        labels: [], 
                        datasets: [
                            { label: isSimMode.value ? 'NAV (SIM)' : 'NAV (Real)', borderColor: lineColor, backgroundColor: areaColor, fill: true, tension: 0.3 }, 
                            { label: 'Cost', borderColor: '#10b981', borderDash: [5,5], pointRadius: 0 }
                        ] 
                    }, 
                    options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false } } 
                });
            }
        }

        function updateCharts() {
            nextTick(() => {
                initCharts();
                if (chartAlloc) {
                    const cats = categoryTotals.value;
                    chartAlloc.data.labels = Object.keys(cats); 
                    chartAlloc.data.datasets[0].data = Object.values(cats); 
                    chartAlloc.data.datasets[0].backgroundColor = Object.keys(cats).map(c => getCategoryColorCode(c));
                    chartAlloc.update();
                }
                if (chartHist && displayHistory.value.length > 0) {
                    const sorted = [...displayHistory.value].sort((a,b) => new Date(a.date) - new Date(b.date));
                    chartHist.data.labels = sorted.map(h => h.date); 
                    chartHist.data.datasets[0].data = sorted.map(h => h.assets); 
                    chartHist.data.datasets[1].data = sorted.map(h => h.cost); 
                    chartHist.update();
                }
            });
        }
        onMounted(() => { setTimeout(updateCharts, 1000); });
        watch([currentTab, exchangeRate, sheetUrl], () => updateCharts());
        return { currentTab, showHistoryModal, showMCModal, isUpdating, isSimMode, toggleSimMode, transactions, realHistoryData, mockHistoryData, displayHistory, enrichedHistory, holdings, categoryTotals, totalStockValueTwd, totalStockCostTwd, totalStockUnrealizedPL, totalStockReturnRate, reversedTransactions, txForm, historyForm, riskParams, stats, mcParams, exchangeRate, sheetUrl, addTransaction, addHistoryRecord, generateMonthlyMockData, removeHistoryByDate, manualUpdate, fetchPrices, exportAll, getTypeColor, getCategoryBadgeClass, getCategoryColorCode, formatNumber, formatPercent, openMonteCarlo, runMonteCarlo, lastUpdate };
    }
}).mount('#app');
</script>
</body>
</html>